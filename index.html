<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Daily Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0 auto;
      padding: 20px;
      background-color: #fdf8f3;
      max-width: 700px;
      color: #333;
    }
    h1, h2 {
      text-align: center;
      color: #2c3e50;
    }
    .container {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .task-item {
      display: flex;
      align-items: center;
      margin: 10px 0;
    }
    .task-item input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.3);
    }
    button {
      padding: 10px 15px;
      margin: 10px 5px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: #4CAF50;
      color: white;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    button:hover { background-color: #3e8e41; }
    #clearBtn { background-color: #f44336; }
    #clearBtn:hover { background-color: #d32f2f; }
    .history-item {
      background: #eef6fa;
      padding: 12px;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    canvas {
      margin-top: 30px;
    }
    @media (max-width: 600px) {
      body { padding: 10px; }
      button { width: 100%; margin: 8px 0; }
    }
  </style>
</head>
<body>
  <h1>💪 My Daily Tracker</h1>
  <div class="container">
    <div id="tasksContainer"></div>
    <button onclick="saveProgress()">Save Progress</button>
    <button id="clearBtn" onclick="clearProgress()">Clear All Progress</button>

    <h2>📊 Progress History</h2>
    <div id="history"></div>
    <canvas id="progressChart"></canvas>
  </div>

  <script>
    const supabase = supabase.createClient(
      'https://fipvrtzlzddexixbfeyv.supabase.co',
      'YOUR_PUBLIC_SUPABASE_ANON_KEY' // replace this with your real key
    );

    const TABLE_NAME = 'progress_log';
    const TASKS = [
      "Japanese Practice for 15 min",
      "Spanish Practice for 15 min",
      "Chinese Practice",
      "Drawing Practice",
      "Sketch for 15 min",
      "SQL Practice",
      "Chess Puzzle (1 game)",
      "Coding Practice",
      "Learn Unreal Engine",
      "3D Practice"
    ];

    let userId = localStorage.getItem('tracker_user_id');
    if (!userId) {
      userId = crypto.randomUUID();
      localStorage.setItem('tracker_user_id', userId);
    }

    const getToday = () => new Date().toISOString().split('T')[0];

    function setupTasks() {
      const container = document.getElementById('tasksContainer');
      container.innerHTML = '';
      TASKS.forEach(task => {
        const div = document.createElement('div');
        div.className = 'task-item';
        div.innerHTML = `
          <input type="checkbox" id="${task}" />
          <label for="${task}">${task}</label>
        `;
        container.appendChild(div);
      });
    }

    async function saveProgress() {
      const date = getToday();
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      const taskData = {};

      checkboxes.forEach(cb => {
        const task = cb.nextElementSibling.textContent;
        taskData[task] = cb.checked;
      });

      const { error } = await supabase
        .from(TABLE_NAME)
        .upsert({ user_id: userId, date, tasks: taskData }, { onConflict: 'user_id,date' });

      if (error) {
        alert("❌ Failed to save progress.");
        console.error(error);
      } else {
        alert("✅ Progress saved!");
        loadProgress();
      }
    }

    async function clearProgress() {
      if (!confirm("Are you sure you want to delete your data?")) return;

      const { error } = await supabase
        .from(TABLE_NAME)
        .delete()
        .eq('user_id', userId);

      if (error) {
        alert("❌ Failed to clear data.");
        console.error(error);
      } else {
        alert("✅ All progress cleared!");
        location.reload();
      }
    }

    async function loadProgress() {
      const { data, error } = await supabase
        .from(TABLE_NAME)
        .select('*')
        .eq('user_id', userId)
        .order('date', { ascending: true });

      if (error) {
        console.error("Load error:", error);
        return;
      }

      const today = getToday();
      const todayRow = data.find(row => row.date === today);

      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => {
        const task = cb.nextElementSibling.textContent;
        cb.checked = todayRow?.tasks?.[task] || false;
      });

      showHistory(data);
    }

    let chart;

    function showHistory(rows) {
      const history = document.getElementById('history');
      history.innerHTML = '';

      const labels = [];
      const percentages = [];

      rows.forEach(row => {
        const tasks = row.tasks || {};
        const completed = Object.values(tasks).filter(Boolean).length;
        const percent = Math.round((completed / TASKS.length) * 100);

        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `<strong>${row.date}</strong> – ${completed}/${TASKS.length} tasks completed (${percent}%)`;
        history.appendChild(div);

        labels.push(row.date);
        percentages.push(percent);
      });

      renderChart(labels, percentages);
    }

    function renderChart(labels, data) {
      const ctx = document.getElementById('progressChart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '% Complete',
            data: data,
            backgroundColor: 'rgba(75,192,192,0.5)',
            borderColor: 'rgba(75,192,192,1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    setupTasks();
    loadProgress();
  </script>
</body>
</html>
